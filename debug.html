<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - å°é›¨å¾®å¯’</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .counter-display {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å°é›¨å¾®å¯’ - åŠŸèƒ½è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h2>ğŸ“Š æ—¶å…‰è®¡æ•°å™¨æµ‹è¯•</h2>
        <div class="counter-display">
            ç›¸æ‹å¤©æ•°: <span id="lovedays">0</span> å¤©<br>
            è·ç¦»ç”Ÿæ—¥: <span id="birthday">0</span> å¤©
        </div>
        <button onclick="testTimeCounter()">æµ‹è¯•æ—¶å…‰è®¡æ•°å™¨</button>
        <div id="timeCounterResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ”— APIè¿æ¥æµ‹è¯•</h2>
        <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
        <div id="apiResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ“ ç¾é£Ÿè®°å½•æµ‹è¯•</h2>
        <button onclick="testFoodAPI()">æµ‹è¯•ç¾é£ŸAPI</button>
        <div id="foodResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ¬ ç”µå½±è®°å½•æµ‹è¯•</h2>
        <button onclick="testMovieAPI()">æµ‹è¯•ç”µå½±API</button>
        <div id="movieResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ“… æ—¥å†åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testCalendarAPI()">æµ‹è¯•æ—¥å†API</button>
        <div id="calendarResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ“ æ–‡ä»¶ç®¡ç†æµ‹è¯•</h2>
        <button onclick="testFileAPI()">æµ‹è¯•æ–‡ä»¶API</button>
        <div id="fileResult"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ” æ§åˆ¶å°æ—¥å¿—</h2>
        <p>è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†çš„æ§åˆ¶å°è¾“å‡º</p>
        <button onclick="showConsoleInfo()">æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯</button>
        <div id="consoleInfo"></div>
    </div>

    <!-- JavaScript -->
    <script src="./scripts/api.js"></script>
    <script src="./scripts/api-data.js"></script>
    <script>
        // ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
        async function waitForServices() {
            console.log('ğŸ”„ ç­‰å¾…æœåŠ¡åˆå§‹åŒ–...');
            
            // ç­‰å¾…APIæœåŠ¡
            let attempts = 0;
            const maxAttempts = 20;
            
            while (attempts < maxAttempts && !window.apiService) {
                console.log(`â³ ç­‰å¾…APIæœåŠ¡åŠ è½½... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            // ç­‰å¾…æ•°æ®ç®¡ç†å™¨
            attempts = 0;
            while (attempts < maxAttempts && !window.dataManager) {
                console.log(`â³ ç­‰å¾…æ•°æ®ç®¡ç†å™¨åŠ è½½... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.log('âœ… æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
            console.log('APIæœåŠ¡çŠ¶æ€:', !!window.apiService);
            console.log('æ•°æ®ç®¡ç†å™¨çŠ¶æ€:', !!window.dataManager);
            
            return {
                apiService: !!window.apiService,
                dataManager: !!window.dataManager
            };
        }
        
        // è°ƒè¯•å‡½æ•°
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testTimeCounter() {
            try {
                const loveStartDate = new Date('2024-04-05');
                const birthdayDate = new Date('2000-07-08');
                const now = new Date();
                
                const loveDays = Math.floor((now - loveStartDate) / (1000 * 60 * 60 * 24));
                const thisYear = now.getFullYear();
                let nextBirthday = new Date(thisYear, birthdayDate.getMonth(), birthdayDate.getDate());
                
                if (nextBirthday < now) {
                    nextBirthday = new Date(thisYear + 1, birthdayDate.getMonth(), birthdayDate.getDate());
                }
                
                const birthdayDays = Math.ceil((nextBirthday - now) / (1000 * 60 * 60 * 24));
                
                document.getElementById('lovedays').textContent = loveDays;
                document.getElementById('birthday').textContent = birthdayDays;
                
                showResult('timeCounterResult', 
                    `âœ… æ—¶å…‰è®¡æ•°å™¨æµ‹è¯•æˆåŠŸï¼<br>
                     ç›¸æ‹å¤©æ•°: ${loveDays}<br>
                     è·ç¦»ç”Ÿæ—¥: ${birthdayDays} å¤©<br>
                     è®¡ç®—æ—¶é—´: ${now.toLocaleString()}`, 'success');
                     
            } catch (error) {
                showResult('timeCounterResult', `âŒ æ—¶å…‰è®¡æ•°å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testApiConnection() {
            try {
                if (!window.apiService) {
                    throw new Error('APIæœåŠ¡æœªåŠ è½½');
                }
                
                const result = await window.apiService.healthCheck();
                showResult('apiResult', `âœ… APIè¿æ¥æˆåŠŸï¼<br>çŠ¶æ€: ${result.status}<br>æ¶ˆæ¯: ${result.message}`, 'success');
            } catch (error) {
                showResult('apiResult', `âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFoodAPI() {
            try {
                console.log('ğŸ½ï¸ å¼€å§‹æµ‹è¯•ç¾é£ŸAPI...');
                
                if (!window.dataManager) {
                    console.error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œå°è¯•ç­‰å¾…...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥api-data.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    }
                }
                
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åŠ è½½ï¼Œå¼€å§‹è·å–ç¾é£Ÿè®°å½•...');
                const records = await window.dataManager.getFoodRecords();
                console.log('ğŸ“ˆ ç¾é£Ÿè®°å½•æ•°æ®:', records);
                
                showResult('foodResult', `âœ… ç¾é£ŸAPIæµ‹è¯•æˆåŠŸï¼<br>è®°å½•æ•°é‡: ${records.length}`, 'success');
            } catch (error) {
                console.error('âŒ ç¾é£ŸAPIæµ‹è¯•å¤±è´¥:', error);
                showResult('foodResult', `âŒ ç¾é£ŸAPIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMovieAPI() {
            try {
                console.log('ğŸ¥ å¼€å§‹æµ‹è¯•ç”µå½±API...');
                
                if (!window.dataManager) {
                    console.error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œå°è¯•ç­‰å¾…...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥api-data.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    }
                }
                
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åŠ è½½ï¼Œå¼€å§‹è·å–ç”µå½±è®°å½•...');
                const records = await window.dataManager.getMovieRecords();
                console.log('ğŸ“ˆ ç”µå½±è®°å½•æ•°æ®:', records);
                
                showResult('movieResult', `âœ… ç”µå½±APIæµ‹è¯•æˆåŠŸï¼<br>è®°å½•æ•°é‡: ${records.length}`, 'success');
            } catch (error) {
                console.error('âŒ ç”µå½±APIæµ‹è¯•å¤±è´¥:', error);
                showResult('movieResult', `âŒ ç”µå½±APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCalendarAPI() {
            try {
                console.log('ğŸ“… å¼€å§‹æµ‹è¯•æ—¥å†API...');
                
                if (!window.dataManager) {
                    console.error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œå°è¯•ç­‰å¾…...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥api-data.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    }
                }
                
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åŠ è½½ï¼Œå¼€å§‹è·å–æ—¥å†å¤‡æ³¨...');
                const notes = await window.dataManager.getCalendarNotes();
                console.log('ğŸ“ˆ æ—¥å†å¤‡æ³¨æ•°æ®:', notes);
                
                const notesCount = Array.isArray(notes) ? notes.length : Object.keys(notes).length;
                showResult('calendarResult', `âœ… æ—¥å†APIæµ‹è¯•æˆåŠŸï¼<br>å¤‡æ³¨æ•°é‡: ${notesCount}`, 'success');
            } catch (error) {
                console.error('âŒ æ—¥å†APIæµ‹è¯•å¤±è´¥:', error);
                showResult('calendarResult', `âŒ æ—¥å†APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFileAPI() {
            try {
                console.log('ğŸ“ å¼€å§‹æµ‹è¯•æ–‡ä»¶API...');
                
                if (!window.dataManager) {
                    console.error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œå°è¯•ç­‰å¾…...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('æ•°æ®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥api-data.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    }
                }
                
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åŠ è½½ï¼Œå¼€å§‹è·å–æ–‡ä»¶åˆ—è¡¨...');
                const files = await window.dataManager.getFileRecords();
                console.log('ğŸ“ˆ æ–‡ä»¶åˆ—è¡¨æ•°æ®:', files);
                
                showResult('fileResult', `âœ… æ–‡ä»¶APIæµ‹è¯•æˆåŠŸï¼<br>æ–‡ä»¶æ•°é‡: ${files.length}`, 'success');
            } catch (error) {
                console.error('âŒ æ–‡ä»¶APIæµ‹è¯•å¤±è´¥:', error);
                showResult('fileResult', `âŒ æ–‡ä»¶APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showConsoleInfo() {
            const info = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                apiServiceLoaded: !!window.apiService,
                dataManagerLoaded: !!window.dataManager,
                isOnline: navigator.onLine,
                timestamp: new Date().toISOString()
            };
            
            showResult('consoleInfo', 
                `ğŸ” ç³»ç»Ÿä¿¡æ¯:<br>
                 æµè§ˆå™¨: ${info.userAgent.split(' ').pop()}<br>
                 URL: ${info.url}<br>
                 APIæœåŠ¡: ${info.apiServiceLoaded ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}<br>
                 æ•°æ®ç®¡ç†å™¨: ${info.dataManagerLoaded ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}<br>
                 ç½‘ç»œçŠ¶æ€: ${info.isOnline ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}<br>
                 æ£€æµ‹æ—¶é—´: ${info.timestamp}`, 'info');
                 
            console.log('ğŸ” è¯¦ç»†ç³»ç»Ÿä¿¡æ¯:', info);
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”§ è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
            const services = await waitForServices();
            
            if (services.apiService) {
                console.log('âœ… APIæœåŠ¡å·²åŠ è½½');
            } else {
                console.error('âŒ APIæœåŠ¡åŠ è½½å¤±è´¥');
            }
            
            if (services.dataManager) {
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åŠ è½½');
            } else {
                console.error('âŒ æ•°æ®ç®¡ç†å™¨åŠ è½½å¤±è´¥');
            }
            
            // å»¶è¿Ÿä¸€ç§’åè‡ªåŠ¨æµ‹è¯•æ—¶å…‰è®¡æ•°å™¨
            setTimeout(() => {
                testTimeCounter();
            }, 1000);
            
            // å»¶è¿Ÿä¸¤ç§’åæ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
            setTimeout(() => {
                showConsoleInfo();
            }, 2000);
        });
    </script>
</body>
</html>