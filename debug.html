<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试页面 - 小雨微寒</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .counter-display {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 小雨微寒 - 功能调试页面</h1>
    
    <div class="debug-section">
        <h2>📊 时光计数器测试</h2>
        <div class="counter-display">
            相恋天数: <span id="lovedays">0</span> 天<br>
            距离生日: <span id="birthday">0</span> 天
        </div>
        <button onclick="testTimeCounter()">测试时光计数器</button>
        <div id="timeCounterResult"></div>
    </div>

    <div class="debug-section">
        <h2>🔗 API连接测试</h2>
        <button onclick="testApiConnection()">测试API连接</button>
        <div id="apiResult"></div>
    </div>

    <div class="debug-section">
        <h2>📝 美食记录测试</h2>
        <button onclick="testFoodAPI()">测试美食API</button>
        <div id="foodResult"></div>
    </div>

    <div class="debug-section">
        <h2>🎬 电影记录测试</h2>
        <button onclick="testMovieAPI()">测试电影API</button>
        <div id="movieResult"></div>
    </div>

    <div class="debug-section">
        <h2>📅 日历功能测试</h2>
        <button onclick="testCalendarAPI()">测试日历API</button>
        <div id="calendarResult"></div>
    </div>

    <div class="debug-section">
        <h2>📁 文件管理测试</h2>
        <button onclick="testFileAPI()">测试文件API</button>
        <div id="fileResult"></div>
    </div>

    <div class="debug-section">
        <h2>🔍 控制台日志</h2>
        <p>请打开浏览器开发者工具查看详细的控制台输出</p>
        <button onclick="showConsoleInfo()">显示系统信息</button>
        <div id="consoleInfo"></div>
    </div>

    <!-- JavaScript -->
    <script src="./scripts/api.js"></script>
    <script src="./scripts/api-data.js"></script>
    <script>
        // 等待服务初始化
        async function waitForServices() {
            console.log('🔄 等待服务初始化...');
            
            // 等待API服务
            let attempts = 0;
            const maxAttempts = 20;
            
            while (attempts < maxAttempts && !window.apiService) {
                console.log(`⏳ 等待API服务加载... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            // 等待数据管理器
            attempts = 0;
            while (attempts < maxAttempts && !window.dataManager) {
                console.log(`⏳ 等待数据管理器加载... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.log('✅ 服务初始化完成');
            console.log('API服务状态:', !!window.apiService);
            console.log('数据管理器状态:', !!window.dataManager);
            
            return {
                apiService: !!window.apiService,
                dataManager: !!window.dataManager
            };
        }
        
        // 调试函数
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testTimeCounter() {
            try {
                const loveStartDate = new Date('2024-04-05');
                const birthdayDate = new Date('2000-07-08');
                const now = new Date();
                
                const loveDays = Math.floor((now - loveStartDate) / (1000 * 60 * 60 * 24));
                const thisYear = now.getFullYear();
                let nextBirthday = new Date(thisYear, birthdayDate.getMonth(), birthdayDate.getDate());
                
                if (nextBirthday < now) {
                    nextBirthday = new Date(thisYear + 1, birthdayDate.getMonth(), birthdayDate.getDate());
                }
                
                const birthdayDays = Math.ceil((nextBirthday - now) / (1000 * 60 * 60 * 24));
                
                document.getElementById('lovedays').textContent = loveDays;
                document.getElementById('birthday').textContent = birthdayDays;
                
                showResult('timeCounterResult', 
                    `✅ 时光计数器测试成功！<br>
                     相恋天数: ${loveDays}<br>
                     距离生日: ${birthdayDays} 天<br>
                     计算时间: ${now.toLocaleString()}`, 'success');
                     
            } catch (error) {
                showResult('timeCounterResult', `❌ 时光计数器测试失败: ${error.message}`, 'error');
            }
        }

        async function testApiConnection() {
            try {
                if (!window.apiService) {
                    throw new Error('API服务未加载');
                }
                
                const result = await window.apiService.healthCheck();
                showResult('apiResult', `✅ API连接成功！<br>状态: ${result.status}<br>消息: ${result.message}`, 'success');
            } catch (error) {
                showResult('apiResult', `❌ API连接失败: ${error.message}`, 'error');
            }
        }

        async function testFoodAPI() {
            try {
                console.log('🍽️ 开始测试美食API...');
                
                if (!window.dataManager) {
                    console.error('数据管理器未加载，尝试等待...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('数据管理器未加载，请检查api-data.js是否正确加载');
                    }
                }
                
                console.log('✅ 数据管理器已加载，开始获取美食记录...');
                const records = await window.dataManager.getFoodRecords();
                console.log('📈 美食记录数据:', records);
                
                showResult('foodResult', `✅ 美食API测试成功！<br>记录数量: ${records.length}`, 'success');
            } catch (error) {
                console.error('❌ 美食API测试失败:', error);
                showResult('foodResult', `❌ 美食API测试失败: ${error.message}`, 'error');
            }
        }

        async function testMovieAPI() {
            try {
                console.log('🎥 开始测试电影API...');
                
                if (!window.dataManager) {
                    console.error('数据管理器未加载，尝试等待...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('数据管理器未加载，请检查api-data.js是否正确加载');
                    }
                }
                
                console.log('✅ 数据管理器已加载，开始获取电影记录...');
                const records = await window.dataManager.getMovieRecords();
                console.log('📈 电影记录数据:', records);
                
                showResult('movieResult', `✅ 电影API测试成功！<br>记录数量: ${records.length}`, 'success');
            } catch (error) {
                console.error('❌ 电影API测试失败:', error);
                showResult('movieResult', `❌ 电影API测试失败: ${error.message}`, 'error');
            }
        }

        async function testCalendarAPI() {
            try {
                console.log('📅 开始测试日历API...');
                
                if (!window.dataManager) {
                    console.error('数据管理器未加载，尝试等待...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('数据管理器未加载，请检查api-data.js是否正确加载');
                    }
                }
                
                console.log('✅ 数据管理器已加载，开始获取日历备注...');
                const notes = await window.dataManager.getCalendarNotes();
                console.log('📈 日历备注数据:', notes);
                
                const notesCount = Array.isArray(notes) ? notes.length : Object.keys(notes).length;
                showResult('calendarResult', `✅ 日历API测试成功！<br>备注数量: ${notesCount}`, 'success');
            } catch (error) {
                console.error('❌ 日历API测试失败:', error);
                showResult('calendarResult', `❌ 日历API测试失败: ${error.message}`, 'error');
            }
        }

        async function testFileAPI() {
            try {
                console.log('📁 开始测试文件API...');
                
                if (!window.dataManager) {
                    console.error('数据管理器未加载，尝试等待...');
                    await waitForServices();
                    
                    if (!window.dataManager) {
                        throw new Error('数据管理器未加载，请检查api-data.js是否正确加载');
                    }
                }
                
                console.log('✅ 数据管理器已加载，开始获取文件列表...');
                const files = await window.dataManager.getFileRecords();
                console.log('📈 文件列表数据:', files);
                
                showResult('fileResult', `✅ 文件API测试成功！<br>文件数量: ${files.length}`, 'success');
            } catch (error) {
                console.error('❌ 文件API测试失败:', error);
                showResult('fileResult', `❌ 文件API测试失败: ${error.message}`, 'error');
            }
        }

        function showConsoleInfo() {
            const info = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                apiServiceLoaded: !!window.apiService,
                dataManagerLoaded: !!window.dataManager,
                isOnline: navigator.onLine,
                timestamp: new Date().toISOString()
            };
            
            showResult('consoleInfo', 
                `🔍 系统信息:<br>
                 浏览器: ${info.userAgent.split(' ').pop()}<br>
                 URL: ${info.url}<br>
                 API服务: ${info.apiServiceLoaded ? '✅ 已加载' : '❌ 未加载'}<br>
                 数据管理器: ${info.dataManagerLoaded ? '✅ 已加载' : '❌ 未加载'}<br>
                 网络状态: ${info.isOnline ? '✅ 在线' : '❌ 离线'}<br>
                 检测时间: ${info.timestamp}`, 'info');
                 
            console.log('🔍 详细系统信息:', info);
        }

        // 页面加载完成后自动运行测试
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔧 调试页面加载完成');
            
            // 等待服务初始化
            const services = await waitForServices();
            
            if (services.apiService) {
                console.log('✅ API服务已加载');
            } else {
                console.error('❌ API服务加载失败');
            }
            
            if (services.dataManager) {
                console.log('✅ 数据管理器已加载');
            } else {
                console.error('❌ 数据管理器加载失败');
            }
            
            // 延迟一秒后自动测试时光计数器
            setTimeout(() => {
                testTimeCounter();
            }, 1000);
            
            // 延迟两秒后显示系统信息
            setTimeout(() => {
                showConsoleInfo();
            }, 2000);
        });
    </script>
</body>
</html>